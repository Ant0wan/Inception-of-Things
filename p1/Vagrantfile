# -*- mode: ruby -*-
# vi: set ft=ruby :

ENV['VAGRANT_DEFAULT_PROVIDER'] = 'libvirt'
VAGRANTFILE_API_VERSION = "2"

$k3s_server_script = <<-SCRIPT
#!/usr/bin/env bash
set -x
export PATH=${PATH}:/usr/local/bin/
curl -sfL https://get.k3s.io | sh -
k3s server &
sudo cat /var/lib/rancher/k3s/server/node-token | sudo tee /vagrant/token
SCRIPT

$k3s_agent_script = <<- SCRIPT
#!/usr/bin/env bash
set -x
export PATH=${PATH}:/usr/local/bin/
curl -sfL https://get.k3s.io | K3S_URL=https://server.k3s.local:6443 K3S_TOKEN=/vagrant/token sh -
SCRIPT

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = "centos/8"

  # Server
  config.vm.define "abarthelS" do |s|
    s.vm.hostname = "abarthelS"
    config.vm.provider "libvirt" do |c|
      c.qemu_use_session = false
      c.memory = "512"
      c.cpus = "1"
    end
    s.vm.network "private_network", ip: "192.168.42.110"
    s.vm.provision "shell", inline: $k3s_server_script

    #s.vm.synced_folder './', '/vagrant', type: 'nfs', nfs_udp: false, nfs_version: 3
    #s.vm.provision "shell", inline: "rsync /vagrant/token vagrant@agent.k3s.local:/vagrant"
  end

  # Agent
  config.vm.define "abarthelSW" do |sw|
    sw.vm.hostname = "abarthelSW"
    sw.vm.provider "libvirt" do |w|
      w.qemu_use_session = false
      w.memory = "512"
      w.cpus = "1"
    end
    sw.vm.network "private_network", ip: "192.168.42.111"
    sw.vm.provision "shell", inline: $k3s_agent_script
  end

end
