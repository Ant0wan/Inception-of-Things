# -*- mode: ruby -*-
# vi: set ft=ruby :

ENV['VAGRANT_DEFAULT_PROVIDER'] = 'libvirt'
VAGRANTFILE_API_VERSION = "2"

$k3s_script = <<-SCRIPT
curl -sfL https://get.k3s.io | sh -
SCRIPT

$k3s_server_script = <<-SCRIPT
export PATH=$PATH:/usr/local/bin/
k3s server &
SCRIPT

$k3s_agent_script = <<-SCRIPT
export PATH=$PATH:/usr/local/bin/
scp -o StrictHostKeyChecking=no root@server.k3s.local:/var/lib/rancher/k3s/server/node-token /vagrant/token
k3s agent -s https://server.k3s.local:6443 -t $(cat /vagrant/token) --with-node-id 1
SCRIPT

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = "centos/8"
  config.vm.provision "shell", inline: $k3s_script
  config.vm.provision "file", source: "./.ssh/id_rsa.pub", destination: "/tmp/id_rsa.pub"
  config.vm.provision "file", source: "./.ssh/id_rsa", destination: "/tmp/id_rsa"
  # Server
  config.vm.define "abarthelS", primary: true do |s|
    s.vm.hostname = "abarthelS"
    config.vm.provider "libvirt" do |c|
      c.qemu_use_session = false
      c.memory = "512"
      c.cpus = "1"
    end
    s.vm.network "private_network", ip: "192.168.42.110"
    s.vm.provision "shell", inline: $k3s_server_script
  end
  # Agent
  config.vm.define "abarthelSW" do |sw|
    sw.vm.hostname = "abarthelSW"
    sw.vm.provider "libvirt" do |w|
      w.qemu_use_session = false
      w.memory = "512"
      w.cpus = "1"
    end
    sw.vm.network "private_network", ip: "192.168.42.111"
    sw.vm.provision "shell", inline: $k3s_agent_script
  end

end
